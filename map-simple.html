<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Directions service</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 50%;
        width: 90%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
    </style>
  </head>
  <body>
    <div id="floating-panel">
    <b>Start: </b>
    <select id="start">
      <option value="UBC, Vancouver">UBC</option>
      <option value="3761 Kincaid St, Burnaby, BC">Kincaid at Smith</option>
      <option value="vancouver, bc">Vancouver</option>
    </select>
    <b>End: </b>
    <select id="end">
      <option value="UBC, Vancouver">UBC</option>
      <option value="3761 Kincaid St, Burnaby, BC">Kincaid at Smith</option>
      <option value="coquitlam, bc">Coquitlam</option>
    </select>
    </div>
    <div id="map"></div>
    <select id="routes">   
    </select>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="xml2json.js"></script>
    <script src="parsexml.js"></script>
    <script>
      var map;

      function initMap() {
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: {
            lat: 49.2827,
            lng: -123.1207
          }
        });
        directionsDisplay.setMap(map);

        var onChangeHandler = function() {
          calculateAndDisplayRoute(directionsService, directionsDisplay);
        };
        document.getElementById('start').addEventListener('change', onChangeHandler);
        document.getElementById('end').addEventListener('change', onChangeHandler);
      }

      String.prototype.cleanName = function() {
        return this.toLowerCase().replace(/[^a-zA-Z]+/g, "");
      }

      function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        directionsService.route({
          origin: document.getElementById('start').value,
          destination: document.getElementById('end').value,
          travelMode: 'TRANSIT',
          transitOptions: {
            // departureTime: new Date()
            departureTime: new Date(2016, 10, 26, 8, 0, 0, 0)

          },
          provideRouteAlternatives: true
        }, function(response, status) {
          if (status === 'OK') {

            for (var i = 0; i < response.routes.length; i++) {
              console.log(response.routes[i]);
              console.log(i);
              new google.maps.DirectionsRenderer({
                map: map,
                directions: response,
                routeIndex: i
              });
              //                    var directionsDisplay = new google.maps.DirectionsRenderer;
              //
              //                    directionsDisplay.setMap(map);
              //                    directionsDisplay.setRouteIndex(i);
              //                    directionsDisplay.setDirections(response);
            }
            var allTehRoutes = {};
            directionsDisplay.setDirections(response);
            console.log(response);

            var userRoutes = {};
            response.routes.forEach((e, i) => {
              var currRoute = userRoutes['route' + i] = {};
              //console.log('route '+i+' legs: ');
              e.legs.forEach((leg, i) => {

                // console.log('   leg '+i+': ');
                var currLeg = currRoute['leg' + i] = {};
                currLeg.steps = [];
                leg.steps.forEach((step, i) => {

                  var currStep = {};
                  if (step.travel_mode === "TRANSIT") {
                    currStep.mode = "TRANSIT";
                    currStep.name = step.transit.line.name;
                    currStep.departureStop = {};
                    currStep.departureStop.lat = step.transit.departure_stop.location.lat();
                    currStep.departureStop.lng = step.transit.departure_stop.location.lng();
                    currStep.departureStop.name = step.transit.departure_stop.name;
                    currStep.departureTime = step.transit.departure_time;
                    currStep.arrivalStop = {}
                    currStep.arrivalStop.lat = step.transit.arrival_stop.location.lat();
                    currStep.arrivalStop.lng = step.transit.arrival_stop.location.lng();
                    currStep.arrivalStop.name = step.transit.arrival_stop.name;
                    currStep.arrivalTime = step.transit.arrival_time;
                    currStep.headSign = step.transit.headsign;
                    currStep.routeNum = step.transit.line.short_name;



                    currLeg.steps.push(currStep);
                    // console.log('   transit:');
                    // console.log('     transit arrival location: lat: '+step.transit.arrival_stop.location.lat()+' '+'long: '+step.transit.arrival_stop.location.lng()+' arrival stop name: '+step.transit.arrival_stop.name);
                    // console.log('     transit arrival time: '+step.transit.arrival_time.text);

                    // console.log('     transit arrival location: lat: '+step.transit.departure_stop.location.lat()+' '+'long: '+step.transit.departure_stop.location.lng()+' departure stop name: '+step.transit.departure_stop.name);
                    // console.log('     transit departure time: '+step.transit.departure_time.text);
                    // console.log('     transit line: '+step.transit.line.name+' '+'id: '+step.transit.line.short_name);
                  } else if (step.travel_mode === "WALKING") {
                    currStep.mode = "WALKING";
                    currStep.walkingSteps = [];
                    step.steps.forEach((walkingStep, i) => {
                      currWalkingStep = {};
                      currWalkingStep.distance = walkingStep.distance;
                      currWalkingStep.duration = walkingStep.duration.value;
                      currWalkingStep.instructions = walkingStep.instructions;
                      currWalkingStep.fromLocn = {};
                      currWalkingStep.fromLocn.lat = walkingStep.start_location.lat();
                      currWalkingStep.fromLocn.lng = walkingStep.start_location.lng();
                      currWalkingStep.toLocn = {};
                      currWalkingStep.toLocn.lat = walkingStep.end_location.lat();
                      currWalkingStep.toLocn.lng = walkingStep.end_location.lng();
                      currStep.walkingSteps.push(currWalkingStep);
                      // console.log('      walkingStep: '+i);
                      // console.log('         walking distance: '+walkingStep.distance.text);
                      // console.log('         walking duration: '+walkingStep.duration.text);
                      // console.log('         walking instructions: '+walkingStep.instructions+' start from: '+'lat: '++' '+'long: '+walkingStep.start_location.lng()+' to end lat: '+walkingStep.end_location.lat()+' '+'long: '+walkingStep.end_location.lng());
                    })
                    currLeg.steps.push(currStep);
                  }

                });
                for (var i = currLeg.steps.length - 1; i >= 0; i--) {
                  step = currLeg.steps[i];
                  var stopList = {};
                  if (step.mode === "TRANSIT") {
                    stopLat = step.arrivalStop.lat.toFixed(5);
                    stopLng = step.arrivalStop.lng.toFixed(5);
                    name = step.arrivalStop.name.cleanName();
                    routeNum = step.routeNum;
                    var responseXmlData = "";
                    axios.get(
                      'https://crossorigin.me/http://api.translink.ca/RTTIAPI/V1/stops', {
                      params: {
                        apiKey: 'INSERT_TRANSLINK_API_KEY_HERE',
                        lat: stopLat,
                        long: stopLng
                      },
                      headers: {
                        'Accept': 'application/json'
                      }
                    }).then(function(response) {
                      responseXmlData = response.data;
                    }).catch(function(error) {
                      console.log();
                    });

                    console.log(routeNum);
                    console.log(name);
                    var stopList = parseXml(responseXmlData);
                    return;
                  }
                }
              });
            })
            console.log(userRoutes);
          } else {
            // window.alert('Directions request failed due to ' + status);
            console.log('Directions request failed due to ' + status);
          }
        });
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4BkkqZ8fH08EVBPgQQ0GRBNG0dQxZFNY&callback=initMap">
    </script>
  </body>
</html>
